---
title: "RDA_our_method"
author: "Zitong Zhang"
# date: 
output: html_document
params: 
  subj_name: "func_20150417"
  data_folder: "../../Results/Rdata/RDA/CDF_v5_debug_freqtrun3_totaltime280/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Import functions --------------------------------------------------------

# rm(list=ls())
file_path = "../Functions"
file.sources = list.files(path = file_path, pattern = "*.R$", full.names = TRUE)
sapply(file.sources, source)

library(tidyverse)
library(gridExtra)
library(R.matlab)
library(data.table)
```


## Read in data analysis results
```{r}
### Read in data analysis results
data_folder = paste0(params$data_folder, params$subj_name, "/") 
path_vec = list.files(data_folder, full.names = TRUE, recursive = TRUE)

res_list = vector(mode = "list", length = length(path_vec))

for(m in 1:length(path_vec)){ 
  path = path_vec[m]
  ### Read in results from data
  load(path)
  res_list[[m]] = res
}


### Collect from all subjects: clusters_list, center_pdf_array, v_vec
clusters_list = lapply(res_list, function(res) res$clusters_list)
center_pdf_array_list = lapply(res_list, function(res) res$center_pdf_array)
v_vec_list = lapply(res_list, function(res) res$v_vec)
t_vec = res$t_vec
n0_mat_list = lapply(v_vec_list, function(v_vec) n0_vec2mat(n0_vec = v_vec/(t_vec[2]-t_vec[1])))

```


## Visualize estimated intensities
```{r}
clus_size_list = lapply(clusters_list, function(clusters)sapply(clusters,length))

for (i in 1:length(center_pdf_array_list)) {
  order_clus = order(rowSums(apply(center_pdf_array_list[[i]], 
      MARGIN = c(1,2),
      function(vec)sum(vec*(t_vec[2]-t_vec[1])))), 
      decreasing = TRUE)
  pdf_array = center_pdf_array_list[[i]][order_clus,order_clus, ,drop=FALSE]
  
  g1 = plot_pdf_array_v2(pdf_array_list = pdf_array, 
                        pdf_true_array = pdf_array,
                        clus_size_vec = clus_size_list[[i]][order_clus],
                        t_vec = t_vec, x_lim = c(), y_lim = c(0,max(pdf_array)))
 
  print(g1)
}

```

```{r}
ICL_mat = t(sapply(res_list,'[[','ICL_vec'))
plot(ICL_mat[1,],type='b',ylim=range(ICL_mat))
lines(ICL_mat[2,],type='b',col=2)
lines(ICL_mat[3,],type='b',col=3)
lines(ICL_mat[4,],type='b',col=4)
lines(ICL_mat[5,],type='b',col=5)


compl_log_lik_mat = t(sapply(res_list,'[[','compl_log_lik_vec'))
plot(compl_log_lik_mat[1,],type='b',ylim=range(compl_log_lik_mat))
lines(compl_log_lik_mat[2,],type='b',col=2)
lines(compl_log_lik_mat[3,],type='b',col=3)
lines(compl_log_lik_mat[4,],type='b',col=4)
lines(compl_log_lik_mat[5,],type='b',col=5)

```

