---
title: "RDA_our_method"
author: "Zitong Zhang"
# date: 
output: html_document
params: 
  subj_name: "func_20150417"
  data_folder: "../../Results/Rdata/RDA_v3/CDF_v5_keeptop_selectNclus_Nrestart1_totaltime336/"
  rmvtop: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Import functions --------------------------------------------------------

# rm(list=ls())
file_path = "../Functions"
file.sources = list.files(path = file_path, pattern = "*.R$", full.names = TRUE)
sapply(file.sources, source)

library(tidyverse)
library(gridExtra)
library(R.matlab)
library(data.table)
```

## Read in network information and data analysis results
```{r}
# Get network information for the L/R side 
path_data = paste0("../../Processed_FunctionalData/",params$subj_name,"/")

### Read information from data
edge_time_mat = as.matrix(read.csv(paste(path_data, '/EdgeTime.csv', sep='')))
edge_time_mat = edge_time_mat[,-1]

avai.inds = as.matrix(read.csv(paste(path_data,'/AvaiNeurons.csv',sep='')))
avai.inds = avai.inds[,-1];

locs.all = as.matrix(read.csv(paste(path_data,'/locs_all.csv',sep='')))
locs.all = locs.all[,-1]
locs_mat = locs.all[avai.inds,]

mnx.all = as.matrix(read.csv(paste(path_data,'/mnx.csv',sep='')))
mnx.all = mnx.all[,-1]
mnx_vec = mnx.all[avai.inds]

dFF.all = as.matrix(fread(paste(path_data,'/dFF.csv',sep='')))
dFF.all = dFF.all[,-1]
dFF_mat = dFF.all[avai.inds,]


```

```{r}
data_folder = paste0(params$data_folder, params$subj_name, "/") 
path_vec = list.files(data_folder, full.names = TRUE, recursive = TRUE)

edge_time_mat_list = vector(mode = "list", length = 2)
avai_inds_list = list()
locs_mat_list = vector(mode = "list", length = 2)
mnx_vec_list = vector(mode = "list", length = 2)
dFF_mat_list = vector(mode = "list", length = 2)

res_list = list()
clusters_list = list()
center_pdf_array_list = list()
v_vec_list = list()

for(m in 1:length(path_vec)){ 
  path = path_vec[m]
  ### Read in results from data
  load(path)
  
  res = res_Nclus[[3]][[1]]
  res_list[[m]] = res
  
  edge_time_mat_list[[m]] = res$edge_time_mat
  avai_inds_list[[m]] = res$avai_inds
  locs_mat_list[[m]] = locs_mat[res$avai_inds, ]
  mnx_vec_list[[m]] = mnx_vec[res$avai_inds]
  dFF_mat_list[[m]] = dFF_mat[res$avai_inds, ]
  
  clusters_list[[m]] = res$clusters_list[[1]]
  center_pdf_array_list[[m]]= res$center_pdf_array
  v_vec_list[[m]] = res$v_vec
  
}


t_vec = res$t_vec
n0_mat_list = lapply(v_vec_list, function(v_vec) n0_vec2mat(n0_vec = v_vec/(t_vec[2]-t_vec[1])))


```


## Visualize estimated intensities
```{r}

### Get connecting probabilities
order_clus_1 = order(rowSums(apply(center_pdf_array_list[[1]], 
      MARGIN = c(1,2),
      function(vec)sum(vec*(t_vec[2]-t_vec[1])))), 
      decreasing = TRUE)
order_clus_2 = order(rowSums(apply(center_pdf_array_list[[2]], 
      MARGIN = c(1,2),
      function(vec)sum(vec*(t_vec[2]-t_vec[1])))), 
      decreasing = TRUE)
# order_clus_1 = order_clus_1[c(2,1,3,4)]

### Get estimated connecting intensities 
clus_size_list = lapply(clusters_list, function(clusters)sapply(clusters,length))

pdf_array_1 = center_pdf_array_list[[1]][order_clus_1,order_clus_1, ,drop=FALSE][1:3,1:3,]
pdf_array_2 = center_pdf_array_list[[2]][order_clus_2,order_clus_2, ,drop=FALSE][1:3,1:3,]

### Adjust smoothness level
for (q in 1:3) {
  for (k in 1:3) {
    pdf_array_1[q,k,] = ksmooth(y=pdf_array_1[q,k,],x=t_vec,kernel='normal',bandwidth = 5)$y
    pdf_array_2[q,k,] = ksmooth(y=pdf_array_2[q,k,],x=t_vec,kernel='normal',bandwidth = 5)$y
  }
}

### Manually shift intensities and time shifts
global_shift = mean(c(max(which(cumsum(pdf_array_2[1,1,])<50/100)) -
                      max(which(cumsum(pdf_array_1[1,1,])<50/100)),
                    max(which(cumsum(pdf_array_2[1,2,])<50/100)) -
                      max(which(cumsum(pdf_array_1[1,2,])<50/100)),
                    max(which(cumsum(pdf_array_2[2,2,])<50/100)) -
                      max(which(cumsum(pdf_array_1[2,2,])<50/100))
                    ))
global_shift_1 = 10
global_shift_2 = global_shift + global_shift_1

pdf_array_1[,,1:(length(t_vec)-global_shift_1)] = pdf_array_1[,,(global_shift_1+1):length(t_vec)]
pdf_array_1[,,(length(t_vec)-global_shift_1+1):length(t_vec)] = 0
v_vec_list[[1]] = v_vec_list[[1]] + global_shift_1*(t_vec[2]-t_vec[1])

pdf_array_2[,,1:(length(t_vec)-global_shift_2)] = pdf_array_2[,,(global_shift_2+1):length(t_vec)]
pdf_array_2[,,(length(t_vec)-global_shift_2+1):length(t_vec)] = 0
v_vec_list[[2]] = v_vec_list[[2]] + global_shift_2*(t_vec[2]-t_vec[1])
n0_mat_list = lapply(v_vec_list, function(v_vec) n0_vec2mat(n0_vec = v_vec/(t_vec[2]-t_vec[1])))


pdf_array_list = list(pdf_array_1, pdf_array_2)
clus_size_vec_1 = clus_size_list[[1]][order_clus_1][1:3]
clus_size_vec_2 = clus_size_list[[2]][order_clus_2][1:3]
tmp = plot_pdf_array_v3(pdf_array_list = pdf_array_list,
                       clus_size_vec_1 = clus_size_vec_1,
                       clus_size_vec_2 = clus_size_vec_2,
                       t_vec = t_vec,
                       y_lim = c(-0.01,max(unlist(pdf_array_list))))

# plot_pdf_array_v2(pdf_array_list = res$center_pdf_array[c(3,1,2,4),c(3,1,2,4),],
#                   pdf_true_array = res$center_pdf_array[c(3,1,2,4),c(3,1,2,4),],
#                   clus_size_vec = sapply(res$clusters_list[c(3,1,2,4)], length),
#                   t_vec = res$t_vec,
#                   y_lim = c(0,max(res$center_pdf_array))
#                   )

g_list = tmp$g_list
big.df = tmp$big.df
inter_quan_len_df = big.df %>%
  mutate(inter_quan_len = quantile_95-quantile_5) %>%
  select(ind_subj, clus.pair, inter_quan_len) %>%
  group_by(clus.pair, ind_subj) %>%
  summarise(inter_quan_len=unique(inter_quan_len)) %>%
  ungroup()
# print(inter_quan_len_df)

g3 = tmp$g
grid.arrange(g3)
```

```{r}
shift_tmp = 43
pdf_array_shift_1 = pdf_array_1
pdf_array_shift_2 = pdf_array_2
for (q in 1:3) {
  pdf_array_shift_1[q,3,] = c(rep(0,shift_tmp),
                            head(pdf_array_1[q,3,],length(t_vec)-shift_tmp))
}
tmp = plot_pdf_array_v3(pdf_array_list = list(pdf_array_shift_1,pdf_array_shift_2),
                       clus_size_vec_1 = clus_size_vec_1,
                       clus_size_vec_2 = clus_size_vec_2,
                       t_vec = t_vec,
                       y_lim = c(-0.01,max(unlist(pdf_array_list))))

# g_list_tmp = tmp$g_list[c(3,5,6)]
# g = arrangeGrob(grobs=g_list_tmp, layout_matrix=matrix(c(1,2,3),nrow=3))
g=tmp$g
grid.arrange(g)
```





```{r}
### Get memberships for ALL nodes
membership_list = lapply(clusters_list, clus2mem)
membership_list[[1]] = clus2mem(clusters_list[[1]][order_clus_1])
membership_list[[2]] = clus2mem(clusters_list[[2]][order_clus_2])
```


## Visualize estimated time shifts

```{r}
### Plot time shifts distribution
data = tibble(v_vec=unlist(v_vec_list),
              AP = c(locs_mat_list[[1]][,1], locs_mat_list[[2]][,1]),
              membership=unlist(membership_list),
              subj=rep(1:length(v_vec_list), times=sapply(v_vec_list,length)))

g5 <- data %>%
  filter(membership<=3) %>%
  group_by(membership) %>%
  mutate(N_node = n()) %>%
  ggplot(aes())+
  geom_density( aes(x=v_vec,group=as.factor(membership),
             size=N_node,
             color=as.factor(membership)), alpha=0.6) +
  scale_color_manual(values=palette()[1+1:4]) +
  scale_fill_manual(values=palette()[1+1:4]) +
  scale_size(range=c(0.3,1)) +
  theme_bw()+
  theme(legend.position = "none") +
  # facet_wrap(~subj) +
  scale_x_continuous() +
  theme(axis.ticks.y = element_blank(),
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.ticks.x = element_blank(),
              axis.text.x = element_blank(),
              axis.title.x = element_blank()) +
  xlab('Time shifts (min)')

print(g5)

g7 <- data %>%
  filter(membership<=3) %>%
  group_by(membership) %>%
  mutate(N_node = n()) %>%
  ggplot(aes())+
  geom_density( aes(x=AP,group=as.factor(membership),
             color=as.factor(membership)), alpha=0.6) +
  scale_color_manual(values=palette()[1+1:4]) +
  scale_fill_manual(values=palette()[1+1:4]) +
  scale_size(range=c(0.3,1)) +
  theme_bw()+
  theme(legend.position = "none") +
  # facet_wrap(~subj) +
  scale_x_continuous() +
  theme(axis.ticks.y = element_blank(),
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.ticks.x = element_blank(),
              axis.text.x = element_blank(),
              axis.title.x = element_blank()) +
  xlab('Time shifts (min)')

print(g7)


plot(data$AP, data$v_vec,col=data$membership+1,pch=16)
ksmooth(data$AP, data$v_vec,kernel = 'normal', bandwidth = 1)->fit
lines(fit$x, fit$y)
```


```{r}
### Get Wan's result
dat=readMat(paste('../../Raw_data/to_shizhe/','Leader_',
                  substr(params$subj_name, start=nchar(params$subj_name)-7,
                         stop=nchar(params$subj_name)),
                  '.mat',sep=''))
activeTime_vec = dat$activeTime * 60
activeTime_vec = activeTime_vec[unlist(avai_inds_list)]

data = tibble(v_vec=activeTime_vec,
              membership=unlist(membership_list),
              subj=rep(1:length(v_vec_list), times=sapply(v_vec_list,length)))

g6 <- data %>%
  filter(membership<=3) %>%
  group_by(membership) %>%
  mutate(N_node = n()) %>%
  ggplot(aes(x=v_vec,group=as.factor(membership),
             size=N_node,
             color=as.factor(membership)))+
  geom_density( aes(), alpha=0.6, linetype=2) +
  scale_color_manual(values=palette()[1+1:4]) +
  scale_fill_manual(values=palette()[1+1:4]) +
  scale_size(range=c(0.3,1)) +
  theme_bw()+
  theme(legend.position = "none") +
  # facet_wrap(~subj) +
  scale_x_continuous() +
  theme(axis.ticks.y = element_blank(),
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.ticks.x = element_blank(),
              axis.text.x = element_blank(),
              axis.title.x = element_blank()) +
  xlab('Time shifts (min)')
print(g6)
```

```{r}
# g_list_2 = c(g_list,list(g5))
# layout_mat = matrix(NA,3,3)
# layout_mat[lower.tri(layout_mat, diag = TRUE)] = 1:6
# layout_mat[1,2]=7
# g = arrangeGrob(grobs=g_list_2, layout_matrix=layout_mat)
# grid.arrange(g)

# print(g6)

```


## Visualize estimated clusters with spatial location

```{r}

### Spatial location  ----

data = as.data.frame(rbind(locs_mat_list[[1]], locs_mat_list[[2]]))
colnames(data) = c('AP','LR','DV')
data = cbind(data,
             membership=unlist(membership_list),
             subj=rep(1:length(membership_list),
                      times=sapply(membership_list,length)))
data = data %>%
  filter(membership <= 3) %>%
  mutate(membership=as_factor(membership))
library(plotly)
fig = plot_ly(data, x = ~LR, y = ~AP, z = ~DV, color = ~membership,
              # colors = c(palette()[c(8,2:6)]),
              colors = c(`0`=palette()[8],
                         `1`=palette()[2],
                         `2`=palette()[3],
                         `3`=palette()[4],
                         `4`=palette()[5],
                         `5`=palette()[6]),
              type = "scatter3d")
fig = fig %>%
  layout(scene = list(aspectmode='manual', aspectratio = list(x=1.5, y=1, z=1)))
fig
```



## Visualize estimated clusters with mnx+/- indicator

```{r}
### mnx decomposition  ----

data = tibble(subj=rep(1:length(membership_list),sapply(membership_list,length)),
              membership=unlist(membership_list),
              mnx=as.factor(unlist(mnx_vec_list)),
              islet=NA)

data_2 = data %>%
  mutate(mnx=factor(mnx,levels=c(1,0)), islet=as.factor(as.numeric(islet)),
         membership=factor(membership, levels=c(0,max(membership):1)))

data_2_left = data_2 %>% filter(subj==1) %>% mutate(membership=fct_drop(membership))
data_2_right = data_2 %>% filter(subj==2) %>% mutate(membership=fct_drop(membership))

fill_color = c(`0`=palette()[8],
               `1`=palette()[2],
               `2`=palette()[3],
               `3`=palette()[4],
               `4`=palette()[5],
               `5`=palette()[6])
### Left spine
g1 = data_2_left %>%
  mutate(membership=factor(membership,levels=c(0,1,2,3,4))) %>%
  ggplot(mapping = aes(fill=mnx,x=membership)) +
  scale_fill_manual(values=fill_color) +
  geom_bar(position="fill") +
  geom_text(data = data_2_left %>%
              count(membership, mnx) %>% group_by(membership) %>%
              summarise(perc=round(n/sum(n),3), mnx=mnx) %>%
              arrange(desc(mnx), .by_group = TRUE) ,
            aes(x = membership, label = scales::percent(perc), y=perc, fill=NULL),
            position = position_fill(0.5), size=2.5)+
  # scale_x_discrete(labels=c("mnx+","mnx-"))+
  xlab("")+
  theme_bw()+
  theme(legend.position = 'none',
        panel.grid  = element_blank(),
        # axis.text = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

### Right spine
g2 = data_2_right %>%
  mutate(membership=factor(membership,levels=c(1,2,3,4))) %>%
  ggplot(mapping = aes(fill=mnx,x=membership)) +
  scale_fill_manual(values=fill_color) +
  geom_bar(position="fill") +
  geom_text(data = data_2_right %>%
              count(membership, mnx) %>% group_by(membership) %>%
              summarise(perc=round(n/sum(n),3), mnx=mnx) %>%
              arrange(desc(mnx), .by_group = TRUE) ,
            aes(x = membership, label = scales::percent(perc), y=perc, fill=NULL),
            position = position_fill(0.5), size=2.5)+
  # scale_x_discrete(labels=c("mnx+","mnx-"))+
  xlab("")+
  theme_bw()+
  theme(legend.position = 'none',
        panel.grid  = element_blank(),
        # axis.text = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g1, g2, ncol=2)
```






#### Shifted edge time distribution of nodes in Cluster 3:
```{r}
(edge_time_mat_list[[1]] - n0_mat_list[[1]])[clusters_list[[1]][order_clus_1][[3]],] %>% c %>% summary

(edge_time_mat_list[[2]] - n0_mat_list[[2]])[clusters_list[[2]][order_clus_2][[3]],] %>% c %>% summary
```

- There is an outlier in shifted edge times of Cluster 3 of Right spine.

#### The outlier shifted edge time corresponds to the connection between 3rd and 4th neurons in Cluster 3.
```{r}
(edge_time_mat_list[[2]] - n0_mat_list[[2]])[clusters_list[[2]][order_clus_2][[3]],clusters_list[[2]][order_clus_2][[3]]]

(edge_time_mat_list[[2]])[clusters_list[[2]][order_clus_2][[3]],clusters_list[[2]][order_clus_2][[3]]]

# order_clus_2 = c(3,1,2,4)
# (res$edge_time_mat - res$)[res$clusters_list[order_clus_2][[3]], ]
```

#### Histogram of edge times associated with 3rd neuron in Cluster 3.
```{r}
hist(edge_time_mat_list[[2]][clusters_list[[2]][order_clus_2][[3]][4],])
```

- The time shifts of neurons cannot exceed earliest edge time, hence the flat area in estimated intensities.

#### The outlier edge time seems to correspond to a edge.
Activity traces of the third and fourth neuron in CLuster 3 (in red) and fifth neuron in Cluster 3 (in black), from 123 min to 125 min.
```{r}
dFF_tmp = dFF_mat_R[avai_inds_R, ]
ind = clusters_list[[2]][order_clus_2][[3]][c(3,4,5)]
plot(0.2+dFF_tmp[ind[1],(1:(240*2))+220*240],type='l',ylim=c(0,0.35),col=2)
lines(0.1+dFF_tmp[ind[2],(1:(240*2))+220*240],type='l',col=2)
lines(dFF_tmp[clusters_list[[2]][order_clus_2][[1]][1],(1:(240*2))+220*240],type='l')

cor_vec = c()
for (t in 1:300) {
  cor_vec[t] = cor(dFF_tmp[ind[1],(1:(240*1))+(t-1)*240],
                   dFF_tmp[ind[2],(1:(240*1))+(t-1)*240])
}
# cor_vec_ave = c()
# for (t in 1:295) {
#   cor_vec_ave[t] = mean(cor_vec[t:(t+4)])
# }
plot(cor_vec,type='l')
tmp = ksmooth(y = cor_vec, x = 1:length(cor_vec), kernel = 'normal', bandwidth = 5)
plot(tmp$x, tmp$y, type='l')
abline(h=0.4)
```

#### The edge time could also be a false positive due to error in activity recording because the two neurons have similar location in AP-LR plane.
```{r}
locs_mat_R[avai_inds_R,][clusters_list[[2]][order_clus_2][[3]][c(3,4)],]
```


