---
title: "RDA_our_method"
author: "Zitong Zhang"
# date: 
output: html_document
params: 
  subj_name: "func_20150417"
  data_folder: "../../Results/Rdata/RDA_v3/CDF_v8_rmv1+3_keeptop_Nrestart1_totaltime336/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Import functions --------------------------------------------------------

# rm(list=ls())
file_path = "../Functions"
file.sources = list.files(path = file_path, pattern = "*.R$", full.names = TRUE)
sapply(file.sources, source)

library(tidyverse)
library(gridExtra)
library(R.matlab)
library(data.table)
```

## Read in network information and data analysis results
```{r}
# Get network information for the L/R side 
path_data = paste0("../../Processed_FunctionalData/",params$subj_name,"/")

### Read information from data
edge_time_mat = as.matrix(read.csv(paste(path_data, '/EdgeTime.csv', sep='')))
edge_time_mat = edge_time_mat[,-1]

avai.inds = as.matrix(read.csv(paste(path_data,'/AvaiNeurons.csv',sep='')))
avai.inds = avai.inds[,-1];

locs.all = as.matrix(read.csv(paste(path_data,'/locs_all.csv',sep='')))
locs.all = locs.all[,-1]
locs_mat = locs.all[avai.inds,]

mnx.all = as.matrix(read.csv(paste(path_data,'/mnx.csv',sep='')))
mnx.all = mnx.all[,-1]
mnx_vec = mnx.all[avai.inds]

dFF.all = as.matrix(fread(paste(path_data,'/dFF.csv',sep='')))
dFF.all = dFF.all[,-1]
dFF_mat = dFF.all[avai.inds,]


```

```{r}
data_folder = paste0(params$data_folder, params$subj_name, "/") 
path_vec = list.files(data_folder, full.names = TRUE, recursive = TRUE)

edge_time_mat_list = vector(mode = "list", length = 2)
avai_inds_list = list()
locs_mat_list = vector(mode = "list", length = 2)
mnx_vec_list = vector(mode = "list", length = 2)
dFF_mat_list = vector(mode = "list", length = 2)

res_list = list()
clusters_list = list()
center_pdf_array_list = list()
v_vec_list = list()

ICL_history_list = list()
compl_log_lik_history_list = list()

for(m in 1:length(path_vec)){ 
  path = path_vec[m]
  ### Read in results from data
  load(path)
  
  N_clus_est = which.max(ICL_history)
  res = res_Nclus[[3]][[1]]
  res_list[[m]] = res
  
  edge_time_mat_list[[m]] = res$edge_time_mat
  avai_inds_list[[m]] = res$avai_inds
  locs_mat_list[[m]] = locs_mat[res$avai_inds, ]
  mnx_vec_list[[m]] = mnx_vec[res$avai_inds]
  dFF_mat_list[[m]] = dFF_mat[res$avai_inds, ]
  
  clusters_list[[m]] = res$clusters_list[[1]]
  center_pdf_array_list[[m]]= res$center_pdf_array
  v_vec_list[[m]] = res$v_vec
  
  ICL_history_list[[m]] = ICL_history
  compl_log_lik_history_list[[m]] = compl_log_lik_history
}


t_vec = res$t_vec
n0_mat_list = lapply(v_vec_list, function(v_vec) n0_vec2mat(n0_vec = v_vec/(t_vec[2]-t_vec[1])))


```



## Visualize estimated intensities
```{r}
if (!exists("t_vec")) {
  t_vec = seq(0,336,1)
}
### Get connecting probabilities
order_clus_1 = order(rowSums(apply(center_pdf_array_list[[1]], 
      MARGIN = c(1,2),
      function(vec)sum(vec*(t_vec[2]-t_vec[1])))), 
      decreasing = TRUE)
order_clus_2 = order(rowSums(apply(center_pdf_array_list[[2]], 
      MARGIN = c(1,2),
      function(vec)sum(vec*(t_vec[2]-t_vec[1])))), 
      decreasing = TRUE)

### Visualize estimated connecting intensities 
clus_size_list = lapply(clusters_list, function(clusters)sapply(clusters,length))

pdf_array_1 = center_pdf_array_list[[1]][order_clus_1,order_clus_1, ,drop=FALSE]#[1:3,1:3,]
pdf_array_2 = center_pdf_array_list[[2]][order_clus_2,order_clus_2, ,drop=FALSE]#[1:3,1:3,]

```

```{r}

g1 = plot_pdf_array_v2(pdf_array_list = center_pdf_array_list[[1]][order_clus_1,order_clus_1, ,drop=FALSE], 
                        pdf_true_array = center_pdf_array_list[[1]][order_clus_1,order_clus_1, ,drop=FALSE],
                        clus_size_vec = clus_size_list[[1]][order_clus_1],
                        t_vec = t_vec, x_lim = c(), y_lim = c(0,max(unlist(center_pdf_array_list))))

g2 = plot_pdf_array_v2(pdf_array_list = center_pdf_array_list[[2]][order_clus_2,order_clus_2, ,drop=FALSE], 
                        pdf_true_array = center_pdf_array_list[[2]][order_clus_2,order_clus_2, ,drop=FALSE],
                        clus_size_vec = clus_size_list[[2]][order_clus_2],
                        t_vec = t_vec, x_lim = c(), y_lim = c(0,max(unlist(center_pdf_array_list))))

grid.arrange(g1, g2, ncol=2)


```


```{r}
print(which.max(ICL_history_list[[1]]+ICL_history_list[[2]]))
for (ind_subj in 1:length(compl_log_lik_history_list)) {
  ICL_history = ICL_history_list[[ind_subj]]
  compl_log_lik_history = compl_log_lik_history_list[[ind_subj]]
  plot(apply(ICL_history,2,max),type='b',ylim=range(ICL_history))
  for (ind_row in 1:nrow(ICL_history)) {
    lines(ICL_history[ind_row,],type='p')
  }

  plot(apply(compl_log_lik_history,2,max),type='b',ylim=range(compl_log_lik_history))
  for (ind_row in 1:nrow(compl_log_lik_history)) {
    lines(compl_log_lik_history[ind_row,],type='p')
  }
  if (ncol(compl_log_lik_history)>=4) {
    print(compl_log_lik_history)
  }
  
}

```



## Visualize estimated time shifts
```{r}
### Get memberships for ALL nodes
membership_list = lapply(clusters_list, clus2mem)
membership_list[[1]] = clus2mem(clusters_list[[1]][order_clus_1])
membership_list[[2]] = clus2mem(clusters_list[[2]][order_clus_2])

```

```{r}
### Plot time shifts distribution
data = tibble(v_vec=unlist(v_vec_list),
              membership=unlist(membership_list),
              subj=rep(1:length(v_vec_list), times=sapply(v_vec_list,length)))

g5 <- data %>%
  filter(membership<=3) %>%
  group_by(membership) %>%
  mutate(N_node = n()) %>%
  ggplot(aes(x=v_vec,group=as.factor(membership),
             size=N_node,
             color=as.factor(membership)))+
  geom_density( aes(), alpha=0.6) +
  scale_color_manual(values=palette()[1+1:4]) +
  scale_fill_manual(values=palette()[1+1:4]) +
  scale_size(range=c(0.3,1)) +
  theme_bw()+
  theme(legend.position = "none") +
  # facet_wrap(~subj) +
  scale_x_continuous() +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank()) +
  xlab('Time shifts (min)')

print(g5)
```


```{r}
### Get Wan's result
dat=readMat(paste('../../Raw_data/to_shizhe/','Leader_',
                  substr(params$subj_name, start=nchar(params$subj_name)-7,
                         stop=nchar(params$subj_name)),
                  '.mat',sep=''))
activeTime_vec = dat$activeTime * 60
activeTime_vec = activeTime_vec[unlist(avai_inds_list)]
data = tibble(v_vec=activeTime_vec,
              membership=unlist(membership_list),
              subj=rep(1:length(v_vec_list), times=sapply(v_vec_list,length)))

g6 <- data %>%
  filter(membership<=3) %>%
  group_by(membership) %>%
  mutate(N_node = n()) %>%
  ggplot(aes(x=v_vec,group=as.factor(membership),
             size=N_node,
             color=as.factor(membership)))+
  geom_density( aes(), alpha=0.6, linetype=2) +
  scale_color_manual(values=palette()[1+1:4]) +
  scale_fill_manual(values=palette()[1+1:4]) +
  scale_size(range=c(0.3,1)) +
  theme_bw()+
  theme(legend.position = "none") +
  # facet_wrap(~subj) +
  scale_x_continuous() +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank()) +
  xlab('Time shifts (min)')

print(g6)

```


## Visualize estimated clusters with spatial location

```{r}

### Spatial location  ----

data = as.data.frame(reduce(locs_mat_list,rbind))
colnames(data) = c('AP','LR','DV')
data = cbind(data,
             membership=as.factor(unlist(membership_list)),
             subj=rep(1:length(membership_list),
                      times=sapply(membership_list,length)))

library(plotly)
fig = plot_ly(data, x = ~LR, y = ~AP, z = ~DV, color = ~membership,
              # colors = c(palette()[c(8,2:6)]),
              colors = c(`0`=palette()[8],
                         `1`=palette()[2],
                         `2`=palette()[3],
                         `3`=palette()[4],
                         `4`=palette()[5],
                         `5`=palette()[6]),
              type = "scatter3d")
fig = fig %>%
  layout(scene = list(aspectmode='manual', aspectratio = list(x=1.5, y=1, z=1)))
fig
```


## Visualize estimated clusters with mnx+/- indicator

```{r}
### mnx decomposition  ----

data = tibble(subj=rep(1:length(membership_list),sapply(membership_list,length)),
              membership=unlist(membership_list),
              mnx=as.factor(unlist(mnx_vec_list)),
              islet=NA)

data_2 = data %>%
  mutate(mnx=factor(mnx,levels=c(1,0)), islet=as.factor(as.numeric(islet)),
         membership=factor(membership, levels=c(0,max(membership):1)))

data_2_left = data_2 %>% filter(subj==1) %>% mutate(membership=fct_drop(membership))
data_2_right = data_2 %>% filter(subj==2) %>% mutate(membership=fct_drop(membership))

fill_color = c(`0`=palette()[8],
               `1`=palette()[2],
               `2`=palette()[3],
               `3`=palette()[4],
               `4`=palette()[5],
               `5`=palette()[6])
### Left spine
g1 = data_2_left %>%
  mutate(membership=factor(membership,levels=c(0,1,2,3,4))) %>%
  ggplot(mapping = aes(fill=mnx,x=membership)) +
  scale_fill_manual(values=fill_color) +
  geom_bar(position="fill") +
  geom_text(data = data_2_left %>%
              count(membership, mnx) %>% group_by(membership) %>%
              summarise(perc=round(n/sum(n),3), mnx=mnx) %>%
              arrange(desc(mnx), .by_group = TRUE) ,
            aes(x = membership, label = scales::percent(perc), y=perc, fill=NULL),
            position = position_fill(0.5), size=2.5)+
  # scale_x_discrete(labels=c("mnx+","mnx-"))+
  xlab("")+
  theme_bw()+
  theme(legend.position = 'none',
        panel.grid  = element_blank(),
        # axis.text = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

### Right spine
g2 = data_2_right %>%
  mutate(membership=factor(membership,levels=c(1,2,3,4))) %>%
  ggplot(mapping = aes(fill=mnx,x=membership)) +
  scale_fill_manual(values=fill_color) +
  geom_bar(position="fill") +
  geom_text(data = data_2_right %>%
              count(membership, mnx) %>% group_by(membership) %>%
              summarise(perc=round(n/sum(n),3), mnx=mnx) %>%
              arrange(desc(mnx), .by_group = TRUE) ,
            aes(x = membership, label = scales::percent(perc), y=perc, fill=NULL),
            position = position_fill(0.5), size=2.5)+
  # scale_x_discrete(labels=c("mnx+","mnx-"))+
  xlab("")+
  theme_bw()+
  theme(legend.position = 'none',
        panel.grid  = element_blank(),
        # axis.text = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g1, g2, ncol=2)
```

